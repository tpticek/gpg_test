---
  - name: Deploy ECM
    hosts: "{{ variable_host_ecm }}"
    vars:
      java_home_var: '{{ folder_dest }}/java/current_jdk'
    environment:
      JAVA_HOME: '{{ java_home_var }}'
      PATH: '{{ java_home_var }}/bin:/usr/edb/as11/bin:{{ ansible_env.PATH }}'
      EDBHOME: /usr/edb/as11
      PGDATA: /usr/edb/as11/data
      PGLOCALEDIR: /usr/edb/as11/share/locale
    roles:
      - role: preparation_server
        when: ecm_deploy == 'yes'

      - role: deploy_metadata_ecm
        when: ecm_deploy == 'yes' and diff_ecm_result.changed

      - role: config_import_ecm
        when: ecm_deploy == 'yes' and repo_ecm_config_reg.stat.isreg is defined and diff_ecm_config_result.changed

      - role: execute_custom_sql_ecm
        when: ecm_deploy == 'yes' and repo_ecm_main_sql_check.stat.isreg is defined and diff_ecm_sql_result.changed

      - role: execute_one_time_sql_ecm
        when: ecm_deploy == 'yes' and diff_ecm_sql_result.changed

      - role: repo_init_state
        when: ecm_deploy == 'yes'

      # Stop EOC if deployment is on ECM
      - role: jboss_stop_ecm
        when:
          - ecm_deploy == 'yes'
          - diff_ecm_result.changed or diff_ecm_config_result.changed # if deployment is on ECM then restart

      - role: jboss_start_ecm
        when:
          - ecm_deploy == 'yes'
          - diff_ecm_result.changed or diff_ecm_config_result.changed # if deployment is on ECM then restart
      # start EOC if deployment is on ECM

      - role: catalog_import_ecm
        when: ecm_deploy == 'yes' and ecm_catalog_import == 'yes' and repo_catalog_reg.stat.exists == true and diff_catalog_result.changed
      # - sentinel_start
      # # - sentinel_stop
      # - jboss_stop_eoc
      # - jboss_stop_ecm
      # - jboss_start_ecm
      # - jboss_start_eoc


# ansible-playbook -i inventory-eocecm eoc_ecm_deploy.yml -v --extra-vars "variable_host_ecm=Telia_LT_DEV2_ecm variable_host_eoc=Telia_LT_DEV2_eoc git_commit_id=${bamboo.planRepository.1.revision}"
